version: 2.1

executors:
  docker-executor:
    docker:
      - image: cimg/node:18.20

  docker-publisher:
    docker:
      - image: cimg/base:stable

jobs:
  # ---- Job 1: Run Tests ----
  test:
    executor: docker-executor
    steps:
      - checkout
      - run: npm install
      - run: npm test -- --watchAll=false

  # ---- Job 2: Build & Push Docker Image ----
  build-and-push:
    executor: docker-publisher
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: false
      - run:
          name: Configure Docker Auth
          command: |
            mkdir -p ~/.docker
            echo $DOCKER_AUTH_CONFIG > ~/.docker/config.json
      - run:
          name: Build Image
          command: |
            IMAGE_TAG=${CIRCLE_SHA1:0:7}
            docker build -t sutarriddhesh22/todo-app:$IMAGE_TAG .
      - run:
          name: Push Image
          command: |
            IMAGE_TAG=${CIRCLE_SHA1:0:7}
            docker push sutarriddhesh22/todo-app:$IMAGE_TAG

  # ---- Job 3: Update Kubernetes Manifests ----
  update-manifests:
    executor: docker-publisher
    steps:
      - checkout
      - run:
          name: Update Deployment Image Tag
          command: |
            IMAGE_TAG=${CIRCLE_SHA1:0:7}
            sed -i "s|sutarriddhesh22/todo-app:.*|sutarriddhesh22/todo-app:$IMAGE_TAG|g" k8s/deployment.yaml
            git config --global user.email "circleci@ci.com"
            git config --global user.name "circleci"
            git add k8s/deployment.yaml
            git commit -m "Update image to $IMAGE_TAG [skip ci]" || echo "No changes to commit"
            git push https://$GITHUB_TOKEN@github.com/riddheshsutar/to-do-app.git HEAD:main

workflows:
  version: 2
  ci-cd:
    jobs:
      - test
      - build-and-push:
          requires:
            - test
      - update-manifests:
          requires:
            - build-and-push
